---

- name: set global facts
  set_fact:
    iam_url: 'https://console.aws.amazon.com/iam/home#home'


- name: call optional notifier
  include: 'roles/{{ notifier_role }}/tasks/main.yml'
  vars:
    message: >
      started running role <b>aws-iam</b>
      on <a href="{{ iam_url }}">account {{ aws_profile }}</a>
  when: notifier_role is defined


- name: set entity type fact to "group"
  set_fact:
    entity_type: group

- include: entities_list.yml

- include: entity_create.yml entity_name={{ item }}
  with_items: configured_entities

- include: entity_delete.yml entity_name={{ item }}
  with_items: existing_entities
  when: item not in configured_entities

- include: entity_sync.yml entity_name={{ item }}
  with_items: configured_entities


- name: set entity type fact to "user"
  set_fact:
    entity_type: user

- include: entities_list.yml

- include: entity_create.yml entity_name={{ item }}
  with_items: configured_entities

- include: entity_delete.yml entity_name={{ item }}
  with_items: existing_entities
  when: item not in configured_entities

- include: entity_sync.yml entity_name={{ item }}
  with_items: configured_entities


- name: set entity type fact to "role"
  set_fact:
    entity_type: role

- include: entities_list.yml

- include: entity_create.yml entity_name={{ item }}
  with_items: configured_entities

- include: entity_delete.yml entity_name={{ item }}
  with_items: existing_entities
  when: item not in configured_entities

- include: entity_sync.yml entity_name={{ item }}
  with_items: configured_entities


- name: call optional notifier
  include: 'roles/{{ notifier_role }}/tasks/main.yml'
  vars:
    message: >
      finished running role <b>aws-iam</b>
      on <a href="{{ iam_url }}">account {{ aws_profile }}</a>
  when: notifier_role is defined
