---

- name: list managed policies attached to
        IAM {{ entity_type }} {{ entity_name }}
  command: >
    aws iam list-attached-{{ entity_type }}-policies
            --{{ entity_type }}-name '{{ entity_name }}'
            --query 'AttachedPolicies[*].PolicyArn'
            --profile '{{ profile }}'
  register: attached_managed_policies
  changed_when: False

- name: set attached managed policies fact for
        IAM {{ entity_type }} {{ entity_name }}
  set_fact:
    attached_managed_policies: >
      {{ attached_managed_policies.stdout | from_json }}

- name: set configured managed policies fact for
        IAM {{ entity_type }} {{ entity_name }}
  set_fact:
    configured_managed_policies: >
      {{ configured_entities[entity_name]["managed_policies"] | default([]) }}

- name: attach managed policies to IAM {{ entity_type }} {{ entity_name }}
  command: >
    aws iam attach-{{ entity_type }}-policy
            --{{ entity_type }}-name '{{ entity_name }}'
            --policy-arn '{{ item }}'
            --profile '{{ profile }}'
  with_items: configured_managed_policies
  when: item not in attached_managed_policies

- name: detach managed policies from IAM {{ entity_type }} {{ entity_name }}
  command: >
    aws iam detach-{{ entity_type }}-policy
            --{{ entity_type }}-name '{{ entity_name }}'
            --policy-arn '{{ item }}'
            --profile '{{ profile }}'
  with_items: attached_managed_policies
  when: item not in configured_managed_policies

- name: call optional notifier
  include: 'roles/{{ notifier_role }}/tasks/main.yml'
  vars:
    message: >
      updated attached managed policies
      for <b>IAM {{ entity_type }} {{ entity_name }}</b>
      in <b>account {{ profile }}</b>
    attachments:
    - text:
      mrkdwn_in: ['fields']
      fields:

      - title: old attached managed policies
        value: >
          {% for policy in attached_managed_policies
          %}<pre>{{ policy }}</pre>{% if not loop.last %}<br/>{% endif
          %}{% endfor %}
        short: true

      - title: new attached managed policies
        value: >
          {% for policy in configured_managed_policies
          %}<pre>{{ policy }}</pre>{% if not loop.last %}<br/>{% endif
          %}{% endfor %}
        short: true

  when: >
    notifier_role is defined and
    attached_managed_policies != configured_managed_policies
